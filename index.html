<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestão de Pátio</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="firebase-config.js"></script>
    
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: manipulation;
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #map {
            flex: 1;
            min-height: 40vh;
        }
        #car-list-container {
            flex: 0 0 50%;
            max-height: 50vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background-color: #f9fafb;
        }
        .leaflet-popup-content {
            margin: 12px;
        }
        #scanner-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70vw;
            height: 70vw;
            max-width: 300px;
            max-height: 300px;
            border: 4px solid #3b82f6;
            border-radius: 8px;
            box-shadow: 0 0 0 100vmax rgba(0,0,0,0.5);
        }
        .car-item {
            transition: all 0.2s;
        }
        .car-item:hover {
            background-color: #f0f9ff;
        }
        .location-btn {
            position: absolute;
            bottom: 80px;
            right: 20px;
            z-index: 400;
            background: white;
            border-radius: 4px;
            padding: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="map"></div>
        
        <div id="car-list-container" class="border-t border-gray-200">
            <div class="sticky top-0 bg-white p-3 border-b border-gray-200 z-10">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">Veículos no Pátio</h2>
                    <div class="flex space-x-2">
                        <button id="filter-btn" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                            </svg>
                        </button>
                        <button id="refresh-btn" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="mt-2 relative">
                    <input type="text" id="search-input" placeholder="Buscar veículo..." class="w-full p-2 pl-10 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-2.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
            
            <div id="car-list" class="p-2 space-y-2">
                <div class="flex flex-col items-center justify-center py-10">
                    <div class="w-16 h-16 border-t-4 border-blue-500 border-solid rounded-full animate-spin"></div>
                    <p class="mt-3 text-gray-500">Carregando veículos...</p>
                </div>
            </div>
        </div>
    </div>

    <button id="scan-btn" class="fixed bottom-6 right-6 bg-blue-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-3xl hover:bg-blue-700 active:bg-blue-800 transition-all duration-200 transform hover:scale-105 z-20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
        </svg>
    </button>
    
    <button id="location-btn" class="location-btn">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
    </button>

    <div id="scanner-modal" class="hidden">
        <div class="w-full max-w-md">
            <div class="text-center mb-4">
                <h3 class="text-xl font-bold text-white">Escaneie o QR Code</h3>
                <p class="text-gray-300 mt-1">Aponte para o código do veículo</p>
            </div>
            
            <div class="relative">
                <div id="reader" class="rounded-lg overflow-hidden"></div>
                <div class="scanner-overlay"></div>
            </div>
            
            <div class="mt-6 flex justify-center">
                <button id="close-scanner-btn" class="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            orderBy,
            where
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const carsCollection = collection(db, "parkedCars");
        
        // Elementos da UI
        const mapElement = document.getElementById('map');
        const scanBtn = document.getElementById('scan-btn');
        const locationBtn = document.getElementById('location-btn');
        const scannerModal = document.getElementById('scanner-modal');
        const closeScannerBtn = document.getElementById('close-scanner-btn');
        const carListDiv = document.getElementById('car-list');
        const searchInput = document.getElementById('search-input');
        const filterBtn = document.getElementById('filter-btn');
        const refreshBtn = document.getElementById('refresh-btn');

        // Estado global
        let map;
        let markers = {};
        let userPosition = null;
        let html5QrCode;
        let currentFilter = 'all';

        // Inicializar Mapa
        function initMap() {
            map = L.map(mapElement, {
                zoomControl: false,
                tap: false
            }).setView([-25.4411, -49.2731], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 19
            }).addTo(map);
            
            // Controle de zoom otimizado para mobile
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);
        }
        
        // Obter localização do usuário
        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            userPosition = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            resolve(userPosition);
                        },
                        error => {
                            console.error("Erro de geolocalização:", error);
                            reject(error);
                        },
                        { 
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                } else {
                    reject("Geolocalização não suportada");
                }
            });
        }

        // Iniciar scanner de QR Code
        function startScanner() {
            scannerModal.classList.remove('hidden');
            
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader", {
                    formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE],
                    experimentalFeatures: {
                        useBarCodeDetectorIfSupported: true
                    }
                });
            }
            
            html5QrCode.start(
                { facingMode: "environment" },
                { 
                    fps: 10, 
                    qrbox: { width: 250, height: 250 },
                    aspectRatio: 1.0
                },
                onScanSuccess,
                () => {} // Ignore error logs for not found QR
            ).catch(err => {
                console.error("Erro ao iniciar scanner:", err);
                alert("Erro ao acessar a câmera: " + err.message);
                stopScanner();
            });
        }
        
        // Parar scanner
        function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    scannerModal.classList.add('hidden');
                }).catch(err => {
                    console.error("Erro ao parar scanner:", err);
                    scannerModal.classList.add('hidden');
                });
            } else {
                scannerModal.classList.add('hidden');
            }
        }
        
        // Sucesso no scan do QR Code
        async function onScanSuccess(decodedText) {
            try {
                const carId = decodedText;
                if (!carId) {
                    showNotification('QR Code inválido', 'error');
                    return;
                }
                
                stopScanner();
                showNotification(`Veículo ${carId} detectado. Salvando...`, 'info');
                
                // Obter localização
                const position = await getUserLocation();
                
                // Salvar no Firebase
                await addDoc(carsCollection, {
                    carId,
                    lat: position.lat,
                    lng: position.lng,
                    timestamp: new Date(),
                    status: 'parked'
                });
                
                showNotification(`Veículo ${carId} salvo com sucesso!`, 'success');
                
            } catch (error) {
                console.error("Erro ao salvar veículo:", error);
                showNotification("Erro ao salvar: " + error.message, 'error');
            }
        }
        
        // Mostrar notificação
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 text-white px-4 py-3 rounded-lg shadow-lg ${colors[type]} notification transition-all transform animate-fadeIn`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('animate-fadeOut');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Atualizar marcadores no mapa
        function updateMarkers(cars) {
            // Remover marcadores antigos
            Object.values(markers).forEach(marker => marker.remove());
            markers = {};
            
            // Adicionar novos marcadores
            cars.forEach(car => {
                const marker = L.marker([car.lat, car.lng])
                    .addTo(map)
                    .bindPopup(`
                        <div class="font-bold">${car.carId}</div>
                        <div class="text-sm text-gray-600">${new Date(car.timestamp).toLocaleString()}</div>
                        <button class="mt-2 px-3 py-1 bg-blue-500 text-white rounded-lg text-sm focus-btn" data-id="${car.id}">
                            Focar
                        </button>
                    `);
                
                markers[car.id] = marker;
            });
            
            // Ajustar visão do mapa se necessário
            if (cars.length > 0) {
                const bounds = Object.values(markers).map(marker => marker.getLatLng());
                map.fitBounds(bounds, { padding: [30, 30] });
            }
        }
        
        // Atualizar lista de veículos
        function updateCarList(cars) {
            if (cars.length === 0) {
                carListDiv.innerHTML = `
                    <div class="text-center py-10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                        </svg>
                        <h3 class="mt-4 text-lg font-medium text-gray-900">Nenhum veículo encontrado</h3>
                        <p class="mt-1 text-gray-500">Escaneie um QR Code para adicionar veículos ao pátio</p>
                    </div>
                `;
                return;
            }
            
            carListDiv.innerHTML = cars.map(car => `
                <div class="car-item bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="p-3 flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    ${car.status === 'parked' ? 'Estacionado' : 'Movido'}
                                </span>
                                <span class="ml-2 text-xs text-gray-500">
                                    ${timeAgo(car.timestamp)}
                                </span>
                            </div>
                            <h3 class="mt-1 text-lg font-bold text-gray-900">${car.carId}</h3>
                        </div>
                        <button class="focus-btn p-2 text-gray-500 hover:text-blue-600" data-id="${car.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Calcular tempo relativo
        function timeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            const intervals = {
                ano: 31536000,
                mês: 2592000,
                semana: 604800,
                dia: 86400,
                hora: 3600,
                minuto: 60,
                segundo: 1
            };
            
            for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInUnit);
                if (interval >= 1) {
                    return `há ${interval} ${unit}${interval > 1 ? 's' : ''}`;
                }
            }
            return 'agora mesmo';
        }
        
        // Filtrar veículos
        function filterCars(cars, filter) {
            switch(filter) {
                case 'recent':
                    return cars.sort((a, b) => b.timestamp - a.timestamp);
                case 'parked':
                    return cars.filter(car => car.status === 'parked');
                default:
                    return cars;
            }
        }
        
        // Focar no veículo
        function focusOnCar(carId) {
            if (markers[carId]) {
                const marker = markers[carId];
                map.flyTo(marker.getLatLng(), 18, {
                    animate: true,
                    duration: 1
                });
                marker.openPopup();
            }
        }
        
        // Event Listeners
        function setupEventListeners() {
            scanBtn.addEventListener('click', startScanner);
            closeScannerBtn.addEventListener('click', stopScanner);
            locationBtn.addEventListener('click', () => {
                if (userPosition) {
                    map.flyTo([userPosition.lat, userPosition.lng], 18);
                } else {
                    getUserLocation().then(pos => {
                        map.flyTo([pos.lat, pos.lng], 18);
                    });
                }
            });
            
            // Focar no carro quando clicar
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('focus-btn')) {
                    const carId = e.target.dataset.id;
                    focusOnCar(carId);
                }
            });
            
            // Busca em tempo real
            searchInput.addEventListener('input', () => {
                const term = searchInput.value.toLowerCase();
                const listItems = document.querySelectorAll('.car-item');
                
                listItems.forEach(item => {
                    const carId = item.querySelector('h3').textContent.toLowerCase();
                    item.style.display = carId.includes(term) ? 'block' : 'none';
                });
            });
            
            // Filtros
            filterBtn.addEventListener('click', () => {
                currentFilter = currentFilter === 'parked' ? 'recent' : 'parked';
                refreshData();
            });
            
            refreshBtn.addEventListener('click', refreshData);
        }
        
        // Obter dados em tempo real do Firebase
        function setupRealtimeUpdates() {
            const q = query(carsCollection, orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snapshot) => {
                const cars = [];
                snapshot.forEach(doc => {
                    cars.push({
                        id: doc.id,
                        ...doc.data(),
                        timestamp: doc.data().timestamp.toDate()
                    });
                });
                
                const filteredCars = filterCars(cars, currentFilter);
                updateMarkers(filteredCars);
                updateCarList(filteredCars);
            });
        }
        
        // Atualizar dados
        function refreshData() {
            carListDiv.innerHTML = `
                <div class="flex justify-center py-4">
                    <div class="w-8 h-8 border-t-4 border-blue-500 border-solid rounded-full animate-spin"></div>
                </div>
            `;
            
            // Simular recarregamento
            setTimeout(setupRealtimeUpdates, 500);
        }
        
        // Inicialização
        async function initApp() {
            try {
                initMap();
                setupEventListeners();
                await getUserLocation();
                setupRealtimeUpdates();
                
                // CSS para animações
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; transform: translateY(-10px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                    @keyframes fadeOut {
                        from { opacity: 1; transform: translateY(0); }
                        to { opacity: 0; transform: translateY(-10px); }
                    }
                    .animate-fadeIn { animation: fadeIn 0.3s forwards; }
                    .animate-fadeOut { animation: fadeOut 0.3s forwards; }
                `;
                document.head.appendChild(style);
                
            } catch (error) {
                console.error("Erro na inicialização:", error);
                showNotification("Erro ao iniciar: " + error.message, 'error');
            }
        }
        
        // Iniciar aplicação
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>